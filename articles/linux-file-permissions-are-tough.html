<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Daniel Wyatt - Linux File Permissions are Tough</title>
  <meta name="description" content="Introduction">

  
  
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/toc.css">
  <link rel="stylesheet" href="/css/lightbox.css">
  <link rel="stylesheet" href="/assets/fontello/css/fontello.css">
  <link rel="canonical" href="/articles/linux-file-permissions-are-tough">
  <link href="https://fonts.googleapis.com/css?family=Unica+One|Vollkorn" rel="stylesheet">

</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    
    
    <a class="site-title" href="/"><img src="/assets/images/logo.svg" />Daniel Wyatt</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <!--
        <a class="page-link" href="/portfolio/">Portfolio</a>
        <a class="page-link" href="/articles/">Articles</a>
        <a class="page-link" href="/assets/DanielWyattResume.pdf">Resume</a>
        -->
        
        
          <a class="page-link " href="/">Home</a>
        
          <a class="page-link " href="/portfolio/">Portfolio</a>
        
          <a class="page-link " href="/articles/">Articles</a>
        
          <a class="page-link " href="/assets/DanielWyattResume.pdf">Resume</a>
        

        

      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Linux File Permissions are Tough</h1>
    <p class="post-meta"><time datetime="2017-04-24T13:10:56-04:00" itemprop="datePublished">Apr 24, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div id="toc-container">
  <table class="toc" id="toc">
    <tbody>
      <tr>
        <td>
          <div id="toctitle">
            <h2>Contents</h2>
          </div>
          <ul>
            <li class="toc_level-1 toc_section-1">
              <a href="#tocAnchor-1-1"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a>
            </li>
            <li class="toc_level-1 toc_section-2">
              <a href="#tocAnchor-1-2"><span class="tocnumber">2</span> <span class="toctext">Ping!</span></a>
            </li>
            <li class="toc_level-1 toc_section-3">
              <a href="#tocAnchor-1-3"><span class="tocnumber">3</span> <span class="toctext">DAC/UGO</span></a>
              <ul>
                <li class="toc_level-2 toc_section-4">
                  <a href="#tocAnchor-1-3-1"><span class="tocnumber">3.1</span> <span class="toctext">Sources</span></a>
                </li>
              </ul>
            </li>
            <li class="toc_level-1 toc_section-5">
              <a href="#tocAnchor-1-5"><span class="tocnumber">4</span> <span class="toctext">Attributes</span></a>
              <ul>
                <li class="toc_level-2 toc_section-6">
                  <a href="#tocAnchor-1-5-1"><span class="tocnumber">4.1</span> <span class="toctext">Sources</span></a>
                </li>
              </ul>
            </li>
            <li class="toc_level-1 toc_section-7">
              <a href="#tocAnchor-1-7"><span class="tocnumber">5</span> <span class="toctext">ACLs</span></a>
              <ul>
                <li class="toc_level-2 toc_section-8">
                  <a href="#tocAnchor-1-7-1"><span class="tocnumber">5.1</span> <span class="toctext">Sources</span></a>
                </li>
              </ul>
            </li>
            <li class="toc_level-1 toc_section-9">
              <a href="#tocAnchor-1-9"><span class="tocnumber">6</span> <span class="toctext">Capabilities</span></a>
              <ul>
                <li class="toc_level-2 toc_section-10">
                  <a href="#tocAnchor-1-9-1"><span class="tocnumber">6.1</span> <span class="toctext">Sources</span></a>
                </li>
              </ul>
            </li>
            <li class="toc_level-1 toc_section-11">
              <a href="#tocAnchor-1-11"><span class="tocnumber">7</span> <span class="toctext">SELinux</span></a>
              <ul>
                <li class="toc_level-2 toc_section-12">
                  <a href="#tocAnchor-1-11-1"><span class="tocnumber">7.1</span> <span class="toctext">Sources</span></a>
                </li>
              </ul>
            </li>
            <li class="toc_level-1 toc_section-13">
              <a href="#tocAnchor-1-13"><span class="tocnumber">8</span> <span class="toctext">Conclusion</span></a>
            </li>
          </ul>
        </td>
      </tr>
    </tbody>
  </table>
</div><h1 id="tocAnchor-1-1">Introduction</h1>

<p>File permissions on a modern Linux system can be confusing.
There are a number of layers that may be involved.</p>

<p>Much of the complexity is hidden by package management systems, but it’s important to know what is going on behind the scenes.</p>

<p>We’re going to walk through a scenario in which we want to simply ping a host (as a normal user).
We’ll encounter a number of issues along the way due to the system being misconfigured/sabotaged for demonstration purposes.</p>

<p>To make things fun, we’ll avoid solutions that would utilize the package management system.</p>

<p>Our test system is running CentOS 7 (1611). Our regular user is ‘daniel’. Some actions are performed directly as root.</p>

<h1 id="tocAnchor-1-2">Ping!</h1>

<p>Ok, let’s give this a shot.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ ping 8.8.8.8
-bash: /usr/bin/ping: Permission denied
</code></pre>
</div>

<p>It’s important to realize that this error is from our shell (bash), which is being denied the rights to execute <code class="highlighter-rouge">/usr/bin/ping</code>.
The error does <em>not</em> come from ping itself, which was never executed.</p>

<p>A number of things can cause this error, but let’s start with the basic file permissions.</p>

<h1 id="tocAnchor-1-3">DAC/UGO</h1>

<p>When it comes to basic file permissions, you want to remember the acronym UGO (user, group, other).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ ll /usr/bin/ping
----------+ 1 root root 62088 Nov  7 05:37 /usr/bin/ping
</code></pre>
</div>

<p>Well the ownership of root:root is OK, but these permissions are all wrong. Let’s fix that:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# chmod 755 /usr/bin/ping
chmod: changing permissions of ‘/usr/bin/ping’: Operation not permitted
</code></pre>
</div>

<p>Well that’s unusual. Even as root, we’re unable to change the permissions of the file.</p>

<p>Perhaps the filesystem is mounted read-only?</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ findmnt $(stat -c %m /usr/bin/ping)
TARGET SOURCE                    FSTYPE OPTIONS
/      /dev/mapper/cl_cent7-root xfs    rw,relatime,seclabel,attr2,inode64,noquota
</code></pre>
</div>

<p>No, the filesystem is mounted read-write.</p>

<p>So why are we not able to modify the permissions of <code class="highlighter-rouge">/usr/bin/ping</code> as superuser?</p>

<h2 id="tocAnchor-1-3-1">Sources</h2>

<ul>
  <li><code class="highlighter-rouge">info coreutils 'File permissions'</code></li>
  <li><code class="highlighter-rouge">info coreutils 'ls invocation'</code></li>
</ul>

<h1 id="tocAnchor-1-5">Attributes</h1>

<p>Many modern Linux filesystems support certain file attributes. Let’s check those!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# lsattr /usr/bin/ping
----i----------- /usr/bin/ping
</code></pre>
</div>

<p>Aha! The immutable attribute is set, so we can’t modify the file data or attributes!</p>

<p>Ok let’s unset the immutable attribute:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# chattr -i /usr/bin/ping
</code></pre>
</div>

<p>Now let’s try to modify the basic permissions as we did before:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# chmod 755 /usr/bin/ping
[root@cent7 ~]# ll /usr/bin/ping
-rwxr-xr-x+ 1 root root 62088 Nov  7 05:37 /usr/bin/ping
</code></pre>
</div>

<p>Great, let’s try to ping again!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ ping 8.8.8.8
-bash: /usr/bin/ping: Permission denied
</code></pre>
</div>

<p>Darn, the same error!</p>

<h2 id="tocAnchor-1-5-1">Sources</h2>

<ul>
  <li><code class="highlighter-rouge">man 1 chattr</code> (package e2fsprogs)</li>
  <li><code class="highlighter-rouge">man 5 xfs</code> (package xfsprogs)</li>
</ul>

<h1 id="tocAnchor-1-7">ACLs</h1>

<p>Access Control Lists are another feature of modern filesystems. Let’s look at those:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ getfacl -p /usr/bin/ping
# file: /usr/bin/ping
# owner: root
# group: root
user::rwx
user:daniel:---
group::---
mask::r-x
other::r-x
</code></pre>
</div>

<p>There’s an ACL that specifically prohibits all access to the user daniel, which I happen to be logged in as.</p>

<p>We don’t really need any ACLs set on ping, so let’s just remove them.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# setfacl -b /usr/bin/ping
</code></pre>
</div>

<p>Let’s try again:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ ping 8.8.8.8
ping: socket: Operation not permitted
</code></pre>
</div>

<p>Progress! This time we can see that ping is being executed, but it is encountering an issue when calling socket().</p>

<h2 id="tocAnchor-1-7-1">Sources</h2>

<ul>
  <li><code class="highlighter-rouge">man 5 acl</code> (package acl)</li>
  <li><code class="highlighter-rouge">man 1 setfacl</code> (package acl)</li>
</ul>

<h1 id="tocAnchor-1-9">Capabilities</h1>

<p>For quite a while, Linux has also had something called capabilities.
These are useful for fine-tuning access requirements for a process.</p>

<p>One special thing that ping requires is the ability to create certain types of sockets (DGRAM, RAW), depending on a few factors.</p>

<p>Normally, these require superuser privileges. So we <em>could</em> set the SUID permission bit and be done with it (which is how it was typically done in the past).</p>

<p>However, using capabilities allows for finer-grained control. So let’s try that:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# setcap cap_net_admin,cap_net_raw+p /usr/bin/ping
[root@cent7 ~]# getcap /usr/bin/ping
/usr/bin/ping = cap_net_admin,cap_net_raw+p
</code></pre>
</div>

<p>And try again:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ ping 8.8.8.8
ping: socket: Permission denied
</code></pre>
</div>

<p>Hmmm, a very similar error. We get “Permission denied” (EACCES), instead of “Operation not permitted” (EPERM).</p>

<h2 id="tocAnchor-1-9-1">Sources</h2>

<ul>
  <li><code class="highlighter-rouge">man 7 capabilities</code> (package man-pages)</li>
  <li><code class="highlighter-rouge">man 3 cap_from_text</code> (package libcap-devel)</li>
</ul>

<h1 id="tocAnchor-1-11">SELinux</h1>

<p>This one is tricky because, on my system, there are no errors logged in the usual places (journalctl, audit.log, etc).
Let’s confirm whether SELinux could be a potential culprit:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# sestatus
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Max kernel policy version:      28
</code></pre>
</div>

<p>Sure enough, SELinux is enabled and enforcing, with the default targeted policy.
Maybe the file label is to blame?</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# restorecon -v /usr/bin/ping
[daniel@cent7 ~]$ ll -Z /usr/bin/ping
-rwx---r-x. root root system_u:object_r:ping_exec_t:s0 /usr/bin/ping
[daniel@cent7 ~]$ ping 8.8.8.8
ping: socket: Permission denied
</code></pre>
</div>

<p>No such luck, restorecon didn’t show any output, which indicates the label was already in compliance with the stored policy (and ping_exec_t certainly looks right).</p>

<p>What about a SELinux boolean?</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ getsebool -a | egrep 'ping|icmp'
selinuxuser_ping --&gt; off
</code></pre>
</div>

<p>How devious! Our user is not unconfined (<code class="highlighter-rouge">id -Z</code>), and we have set <code class="highlighter-rouge">selinuxuser_ping</code> to off, so certain calls to <code class="highlighter-rouge">socket()</code> are being denied.</p>

<p>The fix is simple:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@cent7 ~]# setsebool -P selinuxuser_ping on
</code></pre>
</div>

<p>And now…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[daniel@cent7 ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=39 time=65.9 ms
^C
--- 8.8.8.8 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 65.986/65.986/65.986/0.000 ms
</code></pre>
</div>

<p>It works!</p>

<h2 id="tocAnchor-1-11-1">Sources</h2>

<ol>
  <li><code class="highlighter-rouge">sepolicy manpage -a -p /usr/share/man/man8</code> (package policycoreutils-python)</li>
  <li><code class="highlighter-rouge">mandb</code></li>
  <li><code class="highlighter-rouge">man 8 ping_selinux</code></li>
  <li><code class="highlighter-rouge">man -k _selinux</code></li>
</ol>

<h1 id="tocAnchor-1-13">Conclusion</h1>

<p>Finally, we’re able to ping a host as a normal user. What an accomplishment!</p>

<p>In the process, we have touched on a few different layers that can affect authorization.
In order of complexity (SELinux being the most complex by far):</p>

<ul>
  <li>Basic file permissions - These are the classic user/group/other read/write/execute permissions.
We also mentioned the SUID (setuid) bit that is (at least in part) being replaced by more specific
capabilities.</li>
  <li>Attributes - Attributes are not often used in my experience. Which attributes can be used is
filesystem-specific.</li>
  <li>ACLs - Access Control Lists allow much finer control of permissions than the classic UGO/RWX.
They are supported on all modern Linux filesystems, and are relatively common in my experience.</li>
  <li>SELinux - SELinux is much more common than it used to be. Plenty of system administrators
are guilty of disabling it, but it should be left enabled and enforcing on all modern
RHEL-based distributions.</li>
</ul>

<p>All of these technologies have a good reason to exist and they all work in concert.</p>

<p>A competent system administrator should strive to understand the basics of all of them.</p>


  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Daniel Wyatt
            
            </li>
          <li><a href="mailto:&#68;&#97;&#110;&#105;&#101;&#108;&#46;&#87;&#121;&#97;&#116;&#116;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#68;&#97;&#110;&#105;&#101;&#108;&#46;&#87;&#121;&#97;&#116;&#116;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/dewyatt"><span class="icon-github-circled" style="color: #828282;"></span><span class="username">dewyatt</span></a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>DevOps Professional, Cloud Engineer, Embedded Enthusiast.
</p>
      </div>
    </div>

  </div>

</footer>



    <script src="/js/lightbox.min.js"></script>
    <script>
      var options = {
        carousel:     false,
        closeOnClick: true,
        nextOnClick:  false,
        animation:    false
      };
      var lightbox = new Lightbox();
      lightbox.load(options);
    </script>
  </body>

</html>
